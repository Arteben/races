  <HTML>
  <head>
    <meta charset="utf-8"/>
    <title> Races </title>
    <style>
    </style>
    <script src="js/playground-base.js"></script>
    <script src="js/raphael.js"></script>
  <head/>
  <body>
    <script>
    
    var params = {};

    var ENGINE = {};

    ENGINE.game = {
      
      // create game board
      create: function(){

        var app = this.app;
        var paper = app._svg_;
        var sizes = app._sizes_;
        
        var road_params = {
          cell: 20,
          radius: 50,
        };   

        this._road_p_ = road_params;
        
        var speed = 5;
        
        document.body.style.backgroundColor = "#BBB";
        
        // create array for road
        var road_array = (function(params){

          //count for create arrays;          
          var n, m;
                    
          var array = [];
          for (n = 0; n < params.radius; n++){
            array[n] = [];
            for (m = 0; m < params.radius; m++){
              array[n][m] = 0;
            }
          }
          
          var begin_insland = Math.floor(params.radius * 0.25) - 1;
          var end_insland = Math.floor(params.radius * 0.75) - 1;
          
          var i, j;
          
          for(i in array){
            if (i == 0 || i == array.length - 1) {
              for(j in array[i]){
                array[i][j] = 1;
              } 
            } else if((i > 0 && i < begin_insland) || (i >= end_insland && i < array.length)){
              for (j in array[i]){
                if (j == 0 || j == array[i].length - 1) {
                  array[i][j] = 1;
                }
              }
            } else if (i >= begin_insland && i < end_insland){
              for (j in array[i]){
                if (j == 0 || j == array[i].length - 1 || (j >= begin_insland && j < end_insland)){
                  array[i][j] = 1;
                }
              }
            }
          }
          
          var half = Math.floor(params.radius / 2);
          var road = false;
          
          for (j in array[half]){
            if (array[half][j] == 0 || road){
              road = true;
              if (array[half][j] == 1){
                break;
              } else {
                array[half][j] = 2;
              }
            }
          }
          
          return array;
                    
        }(road_params));
                
        var field = (function(array, p, svg){
          
          var road = svg.set();
          var finish = svg.set();
          var n, m;   
          var cell = p.cell;
        
          for (n = 0; n < array.length; n++){
            for (m = 0; m < array.length; m++){
              if (road_array[n][m] === 0){
                road.push(svg.rect(n * cell, m * cell, cell, cell));
              } else if (array[n][m] == 2){
                finish.push(paper.rect(n * cell, m * cell, cell, cell));
              } 
            }
          }
                  
          road.attr({'fill': '#FFF', 'stroke': '#111', 'stroke-width': 0.1});
          finish.attr({'fill': '#499', 'stroke': '#444', 'stroke-width': 0});
                  
          return {
            board: null,
            road: road,
            finish: finish,
          };
        }(road_array, road_params, paper));
                
        // for step, calcults numbers for renders
        // only move racer
        var steps_racer = {
          cycle: false,
          count: 0, 
          frames: 1000 / speed,
          bit: 0,
          path: '',
          goal: {
            i: 0,
            j: 0,
            x: 0,
            y: 0,
          },
        };
        
        // params for renders objects that moves
        var renders_racer = {        
          status: false,
          racer: {
            x: 0,
            y: 0,
          },
          //line: {
            //begin_point: {
              //x: 0,
              //y: 0,
            //},
            //end_point: {
              //x: 0,
              //y: 0,
            //},  
          //},
        };
                
        // params for racer
        var racer = {
          // current coords racer
          coord: {
            i: 0,
            j: 0,
            x: 0,
            y: 0,
          },          
          point: paper.circle(0, 0, 0.3 * road_params.cell).attr({'fill': '#944'}),
          //path: paper.path("");
        };
        
        // control game
        var game = {
          svg: paper,
          array: road_array,
          field: field,
          racer: racer,
          steps_r: steps_racer,
          renders_r: renders_racer,
          speed: 0,
          // clock, begin - 0
          root: 2,
          current_speed_root: {
            s: 0,
            r: 2,
          },
          // set racer in road without animate
          set_racer: function(coord){

            var xy = this.calcuts_x_y(coord.i, coord.j);
            
            this.racer.coord.i = coord.i;
            this.racer.coord.j = coord.j;
            this.racer.coord.x = xy.x;
            this.racer.coord.y = xy.y;
                                                            
            this.racer.point.attr({
              cx: xy.x,
              cy: xy.y,
            });
            
            paper.setViewBox(0, 0, sizes.w, sizes.h);
          },
          // calcuts_x_y from i, j
          calcuts_x_y: function(i, j){
            return {
                x: i * road_params.cell - road_params.cell / 2,
                y: j * road_params.cell - road_params.cell / 2,
              };
          },
          // goes move for racer
          racer_go: function(){
          
            var s;
            var i = this.racer.coord.i;
            var j = this.racer.coord.j;
            var the = this;
            
            switch (this.root){
              case 0:
                for (s = 1; s <= this.speed; s++ ){
                  if (this.array[i][j - s] !== 0){
                    //s--;
                    boomb(i, j - s);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i, j - s);
                  }
                }
              break;
              case 1:
                for (s = 1; s <= this.speed; s++ ){
                  if (!this.array[i + s] || this.array[i + s][j - s] !== 0){
                    //s--;
                    boomb(i + s, j - s);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i + s, j - s);
                  }
                }
              break;
              case 2: 
                for (s = 1; s <= this.speed; s++ ){
                  if (!this.array[i + s] || this.array[i + s][j] !== 0){
                    //s--;
                    boomb(i + s, j);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i + s, j);
                  }
                }
              break;
              case 3: 
                for (s = 1; s <= this.speed; s++ ){
                  if (!this.array[i + s] || this.array[i + s][j + s] !== 0){
                    //s--;
                    boomb(i + s, j + s);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i + s, j + s);
                  }
                }
              break;
              case 4: 
                for (s = 1; s <= this.speed; s++ ){
                  if (this.array[i][j + s] !== 0){
                    //s--;
                    boomb(i, j + s);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i, j + s);
                  }
                }              
              break;
              case 5: 
                for (s = 1; s <= this.speed; s++ ){
                  if (!this.array[i - s] || this.array[i - s][j + s] !== 0){
                    //s--;
                    boomb(i - s, j + s);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i - s, j + s);
                  }
                }
              break;
              case 6:
                for (s = 1; s <= this.speed; s++ ){
                  if (!this.array[i - s] || this.array[i - s][j] !== 0){
                    //s--;
                    boomb(i - s, j);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i - s, j);
                  }
                }
              break;
              case 7: 
                for (s = 1; s <= this.speed; s++ ){
                  if (!this.array[i - s] || this.array[i - s][j - s] !== 0){
                    //s--;
                    boomb(i - s, j - s);
                    break;
                  } 
                  
                  if (s == this.speed){
                    set_goal(i - s, j - s);
                  }
                }
              break;
            }
            // move racer in i, j
            function set_goal(goal_i, goal_j){
              
              var xy = the.calcuts_x_y(goal_i, goal_j);
              
              steps_racer.cycle = true;
              steps_racer.goal.i = goal_i;
              steps_racer.goal.j = goal_j;
              steps_racer.goal.x = xy.x;
              steps_racer.goal.y = xy.y;

              the.current_speed_root.s = the.speed;
              the.current_speed_root.r = the.root;

              //console.log('racer go in', goal_i, goal_j);
            }
            // breack racer in i, j
            function boomb(racer_i, racer_j){
              console.log('racer break!', racer_i, racer_j);
            
              the.steps_r.count = 0;
              the.steps_r.cycle = false;
              the.renders_r.status = false;

              the.set_racer({i:racer_i, j:racer_j});
              the.speed = 0;

              the.root = (function(road, i, j){
                if (road[i][j - 1] === 0){
                  return 0;
                } else if (road[i + 1] && road[i + 1][j] === 0){
                  return 2;
                } else if (road[i][j + 1] === 0){
                  return 4;
                } else if (road[i - 1] && road[i - 1][j] === 0){
                  return 6;
                } else {
                  return 2;
                }
              }(the.array, racer_i, racer_j));
            }
          },
            
          steps_for_game: function(){
            
            var xy;
                        
            // calcuts params render for current frame                    
            if (this.steps_r.cycle){
              // calcuts the go
              if (this.steps_r.count <= this.steps_r.frames){
                if (this.steps_r.count == 0){
                  this.steps_r.path = 'M' + this.racer.coord.x + ',' + this.racer.coord.y + 
                                          'L' + this.steps_r.goal.x + ',' + this.steps_r.goal.y;
                  this.steps_r.bit = Raphael.getTotalLength(this.steps_r.path) / this.steps_r.frames;
                  this.renders_r.status = true;
                  this.renders_r.racer.x = this.racer.coord.x;
                  this.renders_r.racer.y = this.racer.coord.y;  
                  
                  
                } else {
                  xy = Raphael.getPointAtLength(this.steps_r.path, 
                                        this.steps_r.count * this.steps_r.bit);
                  this.renders_r.racer.x = xy.x;
                  this.renders_r.racer.y = xy.y;            
                }
                
                this.steps_r.count++;
              } else {
              // end move for racer
                this.steps_r.count = 0;
                this.steps_r.cycle = false;
                this.renders_r.status = false;
                this.racer.coord.i = this.steps_r.goal.i;
                this.racer.coord.j = this.steps_r.goal.j;
                this.racer.coord.x = this.steps_r.goal.x;
                this.racer.coord.y = this.steps_r.goal.y;                  
              }
            // start calcuts params for render if it is needs
            } else if (this.speed > 0){
              //console.log(this.speed, this.root);
              this.racer_go();
            } 
          },
          
          renders_for_game: function(){
            if (this.renders_r.status){
              this.racer.point.attr({
                cx: this.renders_r.racer.x,
                cy: this.renders_r.racer.y,
              });
            }
          },
          
          key_down: function(data){
                      
            switch(data.key){
              case 'up':
                if (this.speed < 10 && this.current_speed_root.s >= this.speed){
                  this.speed++;
                }
              break;
              case 'down':
                if (this.speed > 0 && this.current_speed_root.s <= this.speed){
                  this.speed--;
                }
              break;
              case 'right':
                if (this.current_speed_root.r == 7 && this.root == 7){
                  this.root = 0;
                } else if (this.current_speed_root.r < 7 && this.current_speed_root.r >= this.root){
                  this.root++;
                }
              break;
              case 'left':
                console.log('lefffffft!');
                if (this.current_speed_root.r == 0 && this.root == 0){
                  this.root = 7;
                } else if (this.current_speed_root.r > 0 && this.current_speed_root.r <= this.root){
                  this.root--;
                }
              break;
            }
          },
        };
        
        game.set_racer({i: 27, j: 5});
      
        this.step = function(){
          game.steps_for_game();
        };
        
        this.render = function(){
          game.renders_for_game();
        };
        
        this.keydown = function(data){
          game.key_down(data)
        };

        //this.step = game.steps_for_game;
        
        //this.render = game.renders_for_game;
        
        //this.onkeydown = game.key_down;
      },
    };

    // main Application of the game
     var app = new PLAYGROUND.Application({

      //there is loading resorce
      create: function(){

        this._sizes_ = {
          w: window.innerWidth,
          h: window.innerHeight,
        };
        
         this._svg_ = Raphael(0, 0, this._sizes_.w, this._sizes_.h);
      },
      // call after loading
      ready: function(){
        
        this.setState(ENGINE.game);
      },
      
      resize: function(){
        
        this._sizes_.w = window.innerWidth;
        this._sizes_.h = window.innerHeight;
        
        this._svg_.canvas.style.width = this._svg_.canvas.width = this._svg_.width = this._sizes_.w;
        this._svg_.canvas.style.height = this._svg_.canvas.height = this._svg_.height = this._sizes_.h;
        
      },   
    });

    </script>
  </body>
</html>
